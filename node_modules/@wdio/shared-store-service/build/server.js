"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const polka = require('polka');

const {
  json
} = require('@polka/parse');

const store = {};
const app = polka().use(json(), validateBody).post('/get', (req, res) => {
  res.end(JSON.stringify({
    value: store[req.body.key]
  }));
}).post('/set', (req, res) => {
  store[req.body.key] = req.body.value;
  return res.end();
});

const startServer = () => new Promise((resolve, reject) => {
  app.listen(0, err => {
    if (err) {
      return reject(err);
    }

    resolve({
      port: app.server.address().port
    });
  });
});

const stopServer = () => new Promise(resolve => {
  app.server.close(resolve);
});

function validateBody(req, res, next) {
  if (!req.path.endsWith('/get') && !req.path.endsWith('/set')) {
    return next();
  }

  if (req.method === 'POST' && typeof req.body.key !== 'string') {
    res.end(JSON.stringify({
      error: 'Invalid payload, key is required.'
    }));
  }

  next();
}

var _default = {
  startServer,
  stopServer,
  __store: store
};
exports.default = _default;